---
description: active-backup, balance-rr
---

# Бондинг интерфейсов на Linux

> Кратко: bonding объединяет несколько физических интерфейсов в один логический для отказоустойчивости и/или агрегации пропускной способности. Режимы влияют на поведение отправки/приёма и требования к коммутатору.

### Основные режимы (коротко)

* **mode=1 (active-backup)** — один активен, остальные в резерве. Отказ активного вызывает переключение на запасной. Не требует поддержки со стороны коммутатора. Подходит для отказоустойчивости.
* **mode=0 (balance-rr)** — round-robin по пакетам между всеми интерфейсами. Даёт агрегацию пропускной способности на уровне хоста. Может вызывать reordering и требует осторожности с MAC-learning на коммутаторе.
* (для контекста) **mode=4 (802.3ad / LACP)** — агрегирование на основе LACP; требует поддержки коммутатора; обеспечивает и отказоустойчивость, и суммирование пропускной способности.

### Ключевые параметры

* `miimon=<ms>` — мониторинг link (интервал проверки, мс), влияет на скорость обнаружения отказа.
* `updelay`, `downdelay` — задержки при переключении.
* `primary=<iface>` — предпочтительный интерфейс в active-backup.
* `lacp_rate` и `xmit_hash_policy` — для 802.3ad/балансировки хэша.

### Быстрая конфигурация (iproute2, шаги)

```bash
# загрузить модуль
modprobe bonding

# создать бонд
ip link add bond0 type bond mode active-backup

# подготовить физические интерфейсы
ip link set eth0 down
ip link set eth1 down
ip link set eth0 master bond0
ip link set eth1 master bond0

# поднять бонд и адрес
ip link set bond0 up
ip addr add 192.168.1.10/24 dev bond0
ip link set eth0 up
ip link set eth1 up
```

### Пример /etc/modprobe.d/bonding.conf

```
options bonding mode=1 miimon=100 primary=eth0 downdelay=200 updelay=200
```

### Netplan пример (Ubuntu)

```yaml
network:
  version: 2
  ethernets:
    eth0: {}
    eth1: {}
  bonds:
    bond0:
      interfaces: [eth0, eth1]
      parameters:
        mode: active-backup
        primary: eth0
        mii-monitor-interval: 100
      addresses: [192.168.1.10/24]
```

### Как работает переключение (active-backup)

* Состояние link отслеживается через `miimon` (или ARP monitoring).
* При падении активного интерфейса bonda переключает MAC-интерфейса на запасной. Коммутатор обновит MAC-table по source-MAC приходящих кадров.

### Ограничения и практические замечания

* **balance-rr** (mode=0): возможен out-of-order, увеличивает нагрузку на CPU и может путать MAC-learning на коммутаторе. Использовать с осторожностью и тестировать.
* **active-backup**: прост и надёжен. Нет суммирования пропускной способности — только резерв.
* Для суммирования пропускной способности и корректного поведения в сетях с управляемыми коммутаторами предпочитать **802.3ad (LACP)**.
* Настройка `arp_validate` и `arp_all_targets` для контроля ARP-флоу при bonding иногда требуется (предотвращение ARP-flux).
* При использовании VLAN поверх bond создавайте VLAN-субинтерфейсы на `bond0`, например `bond0.10`.

### Проверка и отладка

* `cat /proc/net/bonding/bond0` — статус, active slave, counters.
* `ip -d link show bond0` — детальная информация.
* `ethtool eth0` / `ethtool -S eth0` — статистика физических интерфейсов.
* Логика: отключите активный кабель и убедитесь, что `bond0` продолжает передавать и что MAC в коммутаторе обновился.

### Краткие экзаменационные тезисы

1. `active-backup` = отказоустойчивость без требований к свитчу.
2. `balance-rr` = round-robin, потенциальный reordering и проблемы с MAC-learning.
3. Для настоящего LACP нужна поддержка коммутатора и согласованная конфигурация на обеих сторонах.
4. Проверка: `/proc/net/bonding/bond0`.

### Вопросы для самопроверки

1. Чем `active-backup` отличается от `802.3ad` по требованию к коммутатору?
2. Какие риски у `balance-rr` при использовании в продакшн?
3. Какой параметр влияет на скорость обнаружения падения линка? (ответ: `miimon`)
