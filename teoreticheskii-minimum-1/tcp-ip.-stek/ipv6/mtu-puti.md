---
description: Path MTU Discovery, PMTUD
---

# MTU пути

> Кратко: Path MTU — максимальный размер пакета, который можно пройти по всему маршруту без фрагментации. В IPv6 маршрутизаторы не фрагментируют. Источник узнаёт путь MTU по ICMPv6 `Packet Too Big`.

### Основные понятия

* **MTU** — максимальный размер L3-пакета (в октетах) на конкретном линке.
* **Path MTU (PMTU)** — $$\min(\text{MTU}_1,\text{MTU}_2,\dots,\text{MTU}_n)$$ по всем линкам пути. $$\mathrm{PMTU}=\min_i \mathrm{MTU}_i.$$
* В IPv6 **только источник** может фрагментировать (Fragment header). Роутеры не фрагментируют.

### Как работает PMTUD в IPv6

1. Источник отправляет пакет размера ≤ локального MTU.
2. Если на пути найден линк с меньшим MTU, следующий маршрутизатор сбрасывает пакет и посылает ICMPv6 **Type 2 (Packet Too Big)** с полем **MTU**.
3. Источник получает PTB и уменьшает свой сегмент/фрагментирует согласно указанному MTU, затем повторяет отправку.
4. Для TCP чаще уменьшают MSS (TCP) или фрагментируют/пакуют датаграммы меньше PMTU.

### Важные числовые факты

* Базовый заголовок IPv6 = $$40\ \text{байт}$$.
*   Максимальный полезный L4-пейлоад при заданном MTU:

    $$
    \text{max_payload} = \text{MTU} - 40 - \text{L4_header}.
    $$

    Например для TCP без опций: $$\text{max_payload}=\text{MTU}-40-20.$$
* Минимальный гарантированный MTU для IPv6: $$1280\ \text{байт}$$. Хосты должны корректно обрабатывать пакеты длиной ≥1280.
* При фрагментации смещение фрагмента кратно $$8\ \text{байтам}$$ (offset в единицах 8 октетов). Фрагментный заголовок добавляет $$8\ \text{байт}$$.

### Практические команды

* Посмотреть MTU интерфейса:

```bash
ip link show dev eth0
# или
ip -6 addr show
```

* Проверить PMTU/проверка пути:

```bash
# linux: tracepath автоматически показывает обнаруженную MTU
tracepath -n <host>       # IPv4/IPv6 зависит от утилиты; есть tracepath6
# тестировать пакеты вручную (IPv6)
ping6 -M do -s <size> <host>
# (опция -M do запрещает фрагментацию; размер учитывает L4+L3)
```

* Диагностика ICMPv6 PTB: `tcpdump -n -i eth0 'icmp6 and ip6[40] == 2'` (общая идея).

### Поведенческие нюансы и проблемы

* **Блокировка ICMPv6** на фаерволе ломает PMTUD. Всегда разрешайте ICMPv6 Packet Too Big.
* **Black hole**: если PTB теряются, источник не узнает уменьшенный MTU и пакеты падают. Решения: MSS-clamping на граничном FW (уменьшать TCP MSS) или PLPMTUD (Probe-based PMTU discovery).
* **Fragmentation cost**: фрагментация на источнике повышает overhead и риск потерь (если один фрагмент теряется, весь пакет теряется). Лучше подобрать пакет ≤ PMTU.

### Рекомендации

* На границе сети разрешать ICMPv6 PTB.
* Для TCP делать MSS clamping на NAT/фильтрах, если ожидаются маленькие MTU в пути (VPN, PPPoE).
* Использовать `tracepath`/`tracepath6` для диагностики и проверять MTU на каждом сегменте.
* Стараться избегать отправки больших ненужных неподдерживаемых jumbogram-пакетов; при необходимости использовать Fragment header корректно и учитывать смещение по 8 байт.

### Экзаменационные тезисы

1. В IPv6 маршрутизаторы **не фрагментируют**; фрагментация — обязанность источника.
2. PMTU определяется минимумом MTU по пути: $$\mathrm{PMTU}=\min_i \mathrm{MTU}_i.$$
3. Источник узнаёт PMTU через ICMPv6 **Packet Too Big**. Блокировка этих сообщений ломает связь.
4. Минимальный поддерживаемый MTU в IPv6 = $$1280\ \text{байт}$$.
5. При фрагментации смещение фрагмента кратно $$8$$ байтам; fragment header = $$8\ \text{байт}$$.

### Вопросы для самопроверки

1. Что произойдёт, если на пути есть линк с MTU=576 и ICMPv6 PTB блокируется?
2. Как уменьшить вероятность PMTUD black hole для TCP-потоков?
3. Почему фрагментацию лучше избегать, когда возможно?
