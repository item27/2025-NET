# Префикс (IPv6)

> Кратко: префикс задаёт сетевую часть IPv6-адреса и длину подсети. Записывается `addr/​len`. Практика: подсети обычно **/64**, делегируемые блоки — /48 или /56.

### Определение

* Префикс = старшие $$n$$ бит адреса, описывается как `2001:db8:abcd:0012::/64`.
* Длина префикса $$n$$ в диапазоне $$0 \le n \le 128$$.

### Количество адресов в префиксе

* Число адресов в блоке: $$N_{\text{addr}} = 2^{128-n}.$$
* Примеры:
  * `/128` → $$2^{0}=1$$ адрес (одиночный).
  * `/127` → $$2^{1}=2$$ адреса (p2p, RFC6164).
  * `/64` → $$2^{64}$$ адресов (обычный хост-блок).

### Количество /64 в большем блоке

* Если у вас префикс `/p`, число `/64` подсетей: $$N_{/64} = 2^{64-p}.$$
* Пример: для `/48`: $$N_{/64} = 2^{64-48} = 2^{16} = 65536.$$

### Практические рекомендации

* **Подсеть = /64**. SLAAC и многие стек-механизмы предполагают именно /64. Не дробить /64 для автоконфигурации.
* **Домашние/провайдерские делегирования:** часто ISP делегирует `/56` или `/48` клиенту. `/48` — стандарт для организации; `/56` — частая практика для домашнего CPE.
* **/127** рекомендован для point-to-point линков вместо /64 в некоторых сценариях (RFC6164) чтобы избежать проблемы with address scanning.
* **/128** используется для хоста / loopback / адреса назначенного вручную.

### Администрирование префиксов

* **SLAAC:** роутер в RA даёт префикс с флагом `A` (autonomous) и lifetimes (preferred, valid).
* **DHCPv6-PD:** провайдер делегирует префикс CPE (например, /56), CPE раздаёт /64 внутри LAN.
* **Роутинг и агрегация:** рекламируйте агрегированный префикс (например, /32 или /48) в BGP для уменьшения таблиц маршрутизации.

### Префикс в конфигурации и команды

* Посмотреть адреса/префиксы:

```bash
ip -6 addr show
ip -6 route show
```

* Пример объявления RA/route: `radvd`/`dhcpd` или `network: addr/prefix` в конфигурации.

### Обработка приёмником

* Хост считает адрес «в своём» префиксе если: $$(\text{addr} & \text{mask}_n) = \text{network}.$$
* Сеть (network) = адрес с нулевой хостовой частью (младшие $$128-n$$ бит = 0).

### Безопасные замечания

* При объединении сетей избегайте случайных ULA конфликтов. Для ULA генерируйте случайный /48 (RFC recommendations).
* Не рекламируйте частные/ULA префиксы в глобальный BGP.

### Экзаменационные тезисы

1. Префикс = `addr/len`; длина задаёт сетевую часть.
2. Большинство подсетей в IPv6 — `/64`.
3. Число адресов в префиксе: $$2^{128-n}$$.
4. Для делегирования часто используют `/48` (org) или `/56` (CPE).
5. RA и DHCPv6-PD распространяют префиксы и lifetimes.

### Вопросы для самопроверки

1. Сколько `/64` подсетей в блоке `2001:db8::/40`?
2. Почему в IPv6 рекомендуется использовать `/64` для LAN?
3. Как вычислить адрес сети для `2001:db8:abcd:1234:5678::/60`?

(Короткие ответы: 1→ $$2^{64-40}=2^{24}$$; 2→ SLAAC и привязка EUI-64; 3→ занулить младшие $$128-60=68$$ бит -> сеть = `2001:db8:abcd:1234::/60`.)
