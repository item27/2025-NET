# Заголовок

> Кратко: фиксированный базовый заголовок 40 байт + цепочка расширений. Упрощает маршрутизацию, убирает чек-сумму, переносит фрагментацию и опции в расширения.

### Общая структура (поля и длины)

| Поле                |               Размер |
| ------------------- | -------------------: |
| Version             |   $$4\ \text{bits}$$ |
| Traffic Class       |   $$8\ \text{bits}$$ |
| Flow Label          |  $$20\ \text{bits}$$ |
| Payload Length      |  $$16\ \text{bits}$$ |
| Next Header         |   $$8\ \text{bits}$$ |
| Hop Limit           |   $$8\ \text{bits}$$ |
| Source Address      | $$128\ \text{bits}$$ |
| Destination Address | $$128\ \text{bits}$$ |

Базовый заголовок всегда имеет фиксированный размер $$40\ \text{bytes}$$.

### Краткое описание полей

* **Version** — версия протокола (6).
* **Traffic Class** — приоритет/классы обслуживания (аналог DSCP).
* **Flow Label** — 20-битный идентификатор потока для QoS/ускоренной обработки.
* **Payload Length** — длина данных после базового заголовка в октетах. $$0..65535$$. (Если нужен больше 65535 используется jumbogram/специальные опции).
* **Next Header** — идентификатор следующего заголовка: либо верхний протокол (TCP=6, UDP=17, ICMPv6=58), либо первый расширенный заголовок.
* **Hop Limit** — как TTL в IPv4; уменьшается на каждом маршрутизаторе.
* **Source/Destination** — 128-битные адреса отправителя и получателя.

### Расширенные заголовки (Extension Headers)

* Располагаются в цепочке после базового заголовка. Поле **Next Header** указывает следующий элемент цепочки.
* Типичные расширения: Hop-by-Hop Options, Destination Options, Routing, Fragment, Authentication (AH), Encapsulating Security Payload (ESP).
* **Порядок важен**: Hop-by-Hop должен идти сразу после базового заголовка если присутствует.
* Расширения обрабатывают опции, маршрутизацию, фрагментацию, безопасность.

### Фрагментация

* **Фрагментация выполняется только отправителем** с использованием Fragment extension header. Маршрутизаторы не фрагментируют (Path MTU Discovery).
* Fragment header содержит: Next Header, Reserved, Fragment Offset, M-flag, Identification.

### Особенности и практические следствия

* **Нет чек-суммы в заголовке IPv6.** Экономия работы на маршрутизаторах. Контроль целостности выполняют L2 и верхние протоколы (UDP checksum обязателен; TCP имеет собственную проверку).
* **Фиксированный размер базового заголовка** упрощает fast-path форвардинг.
* **Payload Length = 16 бит** ограничивает обычный payload 65535; jumbogram использует Payload Length=0 и опцию Jumbo Payload.
* **Минимальный MTU для IPv6** на хосте/сети: $$1280\ \text{bytes}$$.

### Полезные команды для диагностики

* `ip -6 route show` / `ip -6 addr show`
* Захват ICMPv6/фрагментов: `tcpdump -n -i eth0 'ip6'`
* В Wireshark: посмотреть цепочку Next Header и расширений.

### Короткие тезисы для экзамена

1. Базовый заголовок IPv6 = $$40\ \text{bytes}$$, адреса по $$128\ \text{bits}$$.
2. Нет чек-суммы. Next Header даёт цепочку расширений.
3. Фрагментация — responsibility отправителя (Fragment header).
4. Payload Length = $$16\ \text{bits}$$; для больших пакетов используются jumbograms.
5. Hop Limit заменяет IPv4 TTL.
