# NAT в IPv4

> Кратко: NAT переводит адреса/порты между внутренней (частной) и внешней (публичной) адресными областями, позволяя экономить публичные адреса и обеспечивать простую форму маршрутизации/изоляции.

### Что такое NAT

* NAT (Network Address Translation) — механизм замены полей адреса/порта в заголовках IP/TCP/UDP при прохождении через границу сети.
* Работает обычно на граничном маршрутизаторе/шлюзе.

### Основные типы NAT

* **Static NAT (one-to-one)**
  * Статическое соответствие: $$\text{PrivateIP} \leftrightarrow \text{PublicIP}$$.
  * Применяется для серверов, доступных из Интернета.
* **Dynamic NAT (pool)**
  * Набор публичных адресов. Приватный узел получает любой свободный публичный адрес из пула.
  * $$\text{PrivateIP} \to \text{PublicIP}_{pool}$$ (временное соответствие).
* **PAT / NAPT / NAT overload (many-to-one)**
  * Многие приватные адреса отображаются на один публичный IP с разными портами.
  * Запись: $$(\text{PrivIP}:\text{PrivPort}) \to (\text{PubIP}:\text{PubPort})$$.
  * Наиболее распространённый тип в домашних/офисных маршрутизаторах.

### Механика работы (PAT пример)

* Исходящий TCP-пакет: `SrcPrivIP:SrcPort -> DstIP:DstPort`.
* NAT меняет `SrcPrivIP:SrcPort` на `PubIP:NewSrcPort` и сохраняет запись в таблице трансляций.
* Возвращающийся пакет: `Dst=PubIP, DstPort=NewSrcPort` → по таблице NAT восстанавливается оригинальный `SrcPrivIP:SrcPort`.

Формально:

$$
(\text{A:pa}) \xrightarrow{\text{NAT}} (\text{X:Pb})
$$

где A — приватный адрес, pa — его порт, X — публичный адрес гейта, Pb — назначенный порт.

### Примеры конфигурации (iptables)

* Простое PAT (MASQUERADE) на Linux:

```bash
# включить форвардинг в /etc/sysctl.conf net.ipv4.ip_forward=1
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
# (eth0 — внешний интерфейс)
```

* Статический NAT:

```bash
iptables -t nat -A PREROUTING -d 1.2.3.4 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:80
iptables -t nat -A POSTROUTING -s 192.168.1.10 -j SNAT --to-source 1.2.3.4
```

### Ограничения и побочные эффекты

* Нарушение end-to-end принципа. Некоторые приложения/протоколы (FTP active, SIP, IPsec AH) требуют дополнительной поддержки (ALG, проброс портов).
* Проблемы с TLS/PKI, если меняется адрес и реализуется контроль по IP.
* Снижение возможности трассировки и отладки (оригинальные адреса скрыты).
* Переиспользование портов может вызвать конфликт при высокой нагрузке.

### NAT и маршрутизация/безопасность

* NAT даёт базовую форму изоляции: внутренние адреса не видны извне.
* NAT не заменяет корректную аутентификацию/файрвол. Не считать NAT мерой безопасности сама по себе.

### Диагностика

* Таблица трансляций на Linux: `conntrack -L` (conntrack tool) или `cat /proc/net/nf_conntrack`.
* Проверить NAT-пересылки: `iptables -t nat -L -n -v`.
* Тесты: `curl --interface <pubIP>` / внешние сервисы для проверки исходящего IP.

### Практические рекомендации

* Для серверов используйте Static NAT или проброс портов (DNAT).
* Для клиентов — PAT/MASQUERADE.
* При сложных протоколах применяйте ALGs с осторожностью; лучше — мультиязные решения (SIP-aware SBC, FTP-proxy).
* Логируйте и контролируйте conntrack-пулы и время жизни записей, чтобы избежать истощения таблицы.

### Экзаменационные тезисы

1. NAT трансформирует адрес/порт на границе сети; PAT позволяет many-to-one.
2. MASQUERADE — динамическая форма SNAT, удобна на интерфейсах с динамическим IP.
3. DNAT используется для проброса портов на внутренние серверы.
4. NAT ломает прозрачность end-to-end и требует дополнительных средств для некоторых протоколов.

### Вопросы для самопроверки

1. Чем отличается SNAT от DNAT?
2. Как NAT обрабатывает ответный TCP-пакет? Опишите по шагам.
3. Почему conntrack может переполниться и как этого избежать?
