---
description: статическая, динамическая
---

# Маршрутизация

> Кратко: маршрутизация — процесс выбора пути для IP-пакета. Статическая задаётся вручную. Динамическая изучает топологию и адаптируется с помощью протоколов.

### Основные определения

* **Маршрут** — правило «куда посылать пакеты» (destination prefix → next-hop/interface).
* **Маршрутизатор** — устройство, принимающее решения на основе таблицы маршрутизации.
* **Next hop** — следующий маршрутизатор или интерфейс для достижения сети назначения.

### Статическая маршрутизация

* Задаётся вручную администратором.
* Преимущества: простота, предсказуемость, безопасность, малы ресурсы CPU/памяти.
* Минусы: не масштабируется, требует ручных изменений при изменениях топологии.
* Примеры (Linux):

```bash
# добавить маршрут к сети 10.0.1.0/24 через 192.168.1.2
ip route add 10.0.1.0/24 via 192.168.1.2 dev eth0
# маршрут по умолчанию
ip route add default via 192.168.1.1
```

* Примеры (Cisco):

```
ip route 10.0.1.0 255.255.255.0 192.168.1.2
ip route 0.0.0.0 0.0.0.0 192.168.1.1
```

* Используется для: простых топологий, статических VPN, резервных путей.

### Динамическая маршрутизация

* Маршрутизаторы обмениваются информацией протоколами (IGP/EGP) и автоматически строят таблицы.
* Плюсы: автоматическая адаптация, масштабируемость, маршрутизация по метрике.
* Минусы: сложность, потребление ресурсов, возможность неправильной конфигурации и циклов.
* Типы протоколов:
  * **IGP (Interior Gateway Protocol)** — внутри автономного домена: RIP, OSPF, IS-IS. Обычно быстрое распространение внутри AS.
  * **EGP (Exterior Gateway Protocol)** — между автономными системами: BGP.
* Механизмы устойчивости: split-horizon, route-poisoning, hold-timers, triggered updates.

### Метрики и выбор лучшего пути

* Каждый протокол использует свою метрику: RIP — hop count; OSPF — cost (обычно inverse bandwidth); EIGRP — composite; BGP — AS-path, local-pref, MED и т.д.
* **Administrative Distance (AD)** — предпочтение между разными источниками маршрутов (малое AD = более доверенный маршрут). Пример: connected (0), static (1), eBGP (20), OSPF (110), RIP (120).

### Конвергенция и стабильность

* **Конвергенция** — время, за которое все маршрутизаторы узнают об изменении и таблицы стабилизируются.
* Динамические протоколы оптимизируют конвергенцию (OSPF/IS-IS быстрее RIP).
* Медленная конвергенция может вызвать blackhole или loops.

## Таблицы маршрутизации

### Структура записи маршрута

Каждая запись обычно содержит:

* Destination prefix (например, `10.0.1.0/24`)
* Next-hop IP или output interface
* Metric (cost/hops)
* Source (static/OSPF/RIP/BGP) и Administrative Distance
* Flags/state (connected, via, unreachable)

### Принцип совпадения — Longest Prefix Match

* При выборе маршрута используется правило «наибольшее совпадение префикса» (Longest Prefix Match).
* Формальное условие: маршрут с маской длины \$$l\$$ подходит если\
  \$$\
  (\text{dst} & \text{mask}\_l) = \text{network}\_l\
  \$$\
  и выбирают такой маршрут, у которого \$$l\$$ максимально.

### Примеры команд просмотра

* Linux: `ip route show`
* Cisco: `show ip route` — отображает сети, source (connected/static/ospf/rip/bgp), AD и metric.
* Пример строки Cisco:

```
O 10.0.2.0/24 [110/20] via 192.168.1.2, 00:01:23, GigabitEthernet0/1
```

где `O`=OSPF, `[110/20]` = AD/metric.

### Поведение при конфликте маршрутов

* Если есть маршруты с одинаковым префиксом, выбирается тот, у которого меньший AD; если AD равны — смотрят метрику; если равны и поддерживается ECMP — возможен equal-cost multi-path (несколько next-hops одновременно).

### Маршрутная агрегация и summarization

* Сжатие нескольких смежных префиксов в один более крупный для уменьшения размеров таблиц. Правило: блоки должны быть выровнены по границе префикса.
* Пример: `10.0.0.0/24` и `10.0.1.0/24` можно агрегировать в `10.0.0.0/23`.

### Redistribute / route leaking

* При интеграции разных протоколов применяют redistribution; нужно осторожно настроить метрики и фильтры, чтобы избежать маршрутных петель.

## Практические советы и отладка

* Проверить таблицу маршрутизации и next-hop: `ip route get <dst>` / `show ip route <dst>`.
* Проверить reachability next-hop: `ping <next-hop>` и `traceroute`.
* Если маршрут есть, но трафик не идёт — проверить ARP/MAC на L2 и ACL/firewall.
* Для проблем с динамикой смотреть лог протоколов, adjacency/neighbor status (OSPF neighbor, BGP sessions).

## Короткие экзаменационные тезисы

1. Статическая = ручная, простая и предсказуемая; динамическая = адаптивная, масштабируемая.
2. Longest Prefix Match решает выбор маршрута.
3. AD определяет приоритет разных источников маршрутов.
4. Метрики зависят от протокола (RIP=hops, OSPF=cost, BGP=AS-path/local-pref).
5. Конвергенция и предотвращение петель — ключевые требования динамической маршрутизации.
