---
icon: delete-right
---

# Таблицы маршрутизации

> Кратко: таблица маршрутизации содержит правила выбора next-hop для каждого целевого префикса. Маршрутизатор ищет самый специфичный маршрут и отправляет пакет на соответствующий интерфейс/next-hop.

### Что хранит запись маршрута

* **Destination / Prefix** — сеть назначения (`10.0.1.0/24`).
* **Next-hop** — IP следующего хопа или `0.0.0.0` для directly connected.
* **Output interface** — физический/логический интерфейс (`eth0`).
* **Metric / Cost** — значение для сравнения путей в протоколе.
* **Source / Protocol** — откуда пришёл маршрут (connected, static, OSPF, BGP и т.д.).
* **Administrative Distance (AD)** — приоритет источников маршрутов (меньше = более доверенный).
* **Flags / Attributes** — e.g. `U`(up), `G`(gateway), `H`(host), `C`(connected), `!`(blackhole).

### Правило выбора маршрута

1. Найти все записи, удовлетворяющие условию совпадения: $$(\text{dst} ;\&; \text{mask}_l) = \text{network}_l$$ для каждой записи с длиной префикса (l).
2. Выбрать маршрут с **максимальной длиной префикса** (Longest Prefix Match, LPM): $$l = \max{l_i \mid \text{match}_i}.$$
3. Если несколько записей с одинаковым (l):
   * выбрать запись с **меньшей AD**;
   * при равной AD — выбрать с меньшей **metric**;
   * при равных метриках возможно **ECMP** (Equal-Cost Multi-Path) — распределение по нескольким next-hop.
4. Если ничего не найдено — использовать `default` (`0.0.0.0/0`) или отбросить пакет.

### Пример поиска (практика)

Таблица:

* `10.0.0.0/8 via 192.0.2.1`
* `10.1.0.0/16 via 192.0.2.2`
* `10.1.2.0/24 via 192.0.2.3`
* `0.0.0.0/0 via 203.0.113.1`

Целевой адрес `10.1.2.45` → совпадают все три `10.*`. Выбираем `/24` (`10.1.2.0/24`) как самый специфичный. Next-hop = `192.0.2.3`.

### ECMP (Equal-Cost Multi-Path)

* Если обнаружены несколько маршрутов с одинаковым префиксом, AD и metric, то включается ECMP.
* Пакеты распределяются по next-hop на основе hash(src,dst,port) или round-robin, в зависимости от реализации.

### Типы маршрутов

* **Connected** — интерфейс в той же подсети.
* **Static** — вручную заданный маршрут.
* **Dynamic (IGP/EGP)** — получен от протоколов (RIP/OSPF/BGP).
* **Policy / Blackhole / Reject** — специальные записи (discard, unreachable).

### Просмотр и команды

#### Linux

```bash
ip route show
ip route get 8.8.8.8
ip -4 route
# старые утилиты
route -n
netstat -rn
```

**Пример вывода `ip route`:**

```
10.1.2.0/24 via 192.0.2.3 dev eth1 proto static metric 100
default via 203.0.113.1 dev eth0 proto static
192.168.1.0/24 dev eth2 proto kernel scope link src 192.168.1.10
```

#### Cisco / IOS

```
show ip route
# примечание: вывод показывает source (C,S,O,B), AD/metric и next-hop
```

### Трассировка логики маршрутизации

* `ip route get <dst>` показывает конкретный выбор маршрута и интерфейс.
* `traceroute` / `mtr` показывают путь на уровне IP.
* Проверять reachability next-hop: `ping <next-hop>`; если next-hop недоступен — маршрут не сработает.

### Аггрегация и summarization

* Сжатие нескольких префиксов в один более крупный сокращает таблицу маршрутизации.
* Правило: можно агрегировать только выровненные блоки. Пример: `10.0.0.0/24` + `10.0.1.0/24` → `10.0.0.0/23`.

### Взаимосвязь с FIB/RIB

* **RIB (Routing Information Base)** — совокупность всех полученных маршрутов (от всех источников).
* **FIB (Forwarding Information Base)** — оптимизированная таблица, используемая для форвардинга пакетов. FIB строится на основе RIB с учётом AD/политик.

### Политики и route-maps

* Маршруты можно фильтровать/изменять при вводе (route-maps, prefix-lists, policy routing).
* Policy routing (Linux `ip rule` / `ip route` tables) позволяет выбирать таблицу маршрутов по source, mark, fwmark и т.д.

### Диагностика проблем

* Нет маршрута → `ip route get` вернёт ошибку.
* Неправильный next-hop → ping next-hop падает.
* Наличие неправильного более специфичного маршрута может "заблокировать" нужный путь; искать по LPM.
* Проверять AD и источник маршрута (`show ip route` / `ip route show proto ...`).

### Команды полезные для отладки

```bash
ip route get <dst>
ip -s route show               # статистика
ip rule show                   # policy routing rules
ip route flush cache           # (если есть кэш маршрутов в старых ядрах)
# для BGP/OSPF смотреть соседей/таблицы на роутере (show ip bgp/ospf ...)
```

### Короткие экзаменационные тезисы

1. Longest Prefix Match решает выбор маршрута. $$l = \max l_i$$.
2. Если одинаковый префикс — смотрят AD, затем metric.
3. RIB содержит все маршруты; FIB — то, что реально форвардит пакеты.
4. ECMP допускает несколько next-hop при равных метриках.
5. `ip route get` — быстрый способ проверить выбор маршрута.

### Вопросы для самопроверки

1. Какой маршрут выберет таблица для `192.168.2.5`, если есть `192.168.0.0/16` и `192.168.2.0/24`?
2. Что делает `ip route get` и чем он полезен?
3. Как проверить, что маршрут из BGP действительно установлен в FIB?
