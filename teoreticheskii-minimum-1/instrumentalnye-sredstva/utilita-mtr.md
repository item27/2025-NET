---
description: смысл выводимых значений
---

# Утилита mtr

> Кратко: `mtr` сочетает `traceroute` и `ping`. Показывает пути и в реальном времени собирает статистику задержек и потерь по каждому хопу.

### Назначение

* Быстрая диагностика маршрута и качества связи.
* Показывает RTT и packet loss по каждому узлу на пути.
* Удобен для передачи отчётов провайдерам.

### Базовый запуск

* Интерактивно:

```bash
mtr example.com
```

* В режиме отчёта (скрипты, логирование):

```bash
mtr -r -c 100 -w -n example.com
```

где `-r` = report, `-c 100` = 100 циклов, `-w` = wide формат, `-n` = не делать DNS lookup.

### Частые опции (полезные)

* `-r, --report` — режим отчёта (выход после `-c` циклов).
* `-c, --report-cycles COUNT` — число циклов/пингов в отчёте.
* `-n, --no-dns` — показывать IP вместо имён.
* `-i, --interval SECONDS` — интервал между запросами (по умолчанию 1s).
* `-s, --psize BYTES` — размер пакета (включая IP/ICMP заголовки).
* `-u, --udp` — использовать UDP-пробы.
* `-T, --tcp` — использовать TCP SYN-пробы.
* `-4` / `-6` — forced IPv4 / IPv6.
* `--tcp -P 80` — указать порт для TCP (если поддерживается сборкой).
* Нужен `sudo` для некоторых типов проб (raw sockets).

### Что показывают столбцы (типичный вывод)

`Host` | `Loss%` | `Snt` | `Last` | `Avg` | `Best` | `Wrst` | `StDev`

* **Loss%** — процент потерянных ответов на этот хоп.
* **Snt** — отправленные запросы.
* **Last/Avg/Best/Wrst/StDev** — RTT в мс: последний, средний, лучшая, худшая, стандартное отклонение.

Формула потерь: $$\text{loss%} = \frac{\text{lost}}{\text{sent}}\cdot 100.$$

### Как интерпретировать результаты — правила практики

1. **Потери на промежуточном хопе ≠ обязательно потеря трафика клиенту.** Многие маршрутизаторы понижают приоритет ICMP/TTL-expired и не отвечают на все запросы.
2. **Потери на последнем хопе = реальная end-to-end потеря.** Если последний хоп показывает loss, проблема на пути к самому хосту или на самом хосте.
3. **Пиковые RTT на одном/нескольких подряд хопах** часто означают перегрузку или очередь на интерфейсе.
4. **Наличие `*` на конкретном хопе** может означать фильтрацию TTL-exceeded/ICMP.
5. Используйте `--tcp -P <port>` если ICMP/UDP блокируются и вам важен путь TCP к сервису (например, порт 80/443).

### Примеры полезных команд

* Короткий non-interactive отчёт (100 циклов), без DNS, IPv6:

```bash
sudo mtr -6 -r -c 100 -n example.com
```

* TCP probe к порту 443:

```bash
sudo mtr --tcp -P 443 -r -c 50 example.com
```

* Увеличить размер пакета до 1200 байт:

```bash
mtr -r -c 50 -s 1200 example.com
```

### Ограничения и подводные камни

* `mtr` использует активные пробы. Результаты зависят от того, как хопы обрабатывают ICMP/UDP/TCP.
* Фаерволы/ACL могут блокировать ответы и исказить картину.
* Не полагайтесь только на `Loss%` промежуточного хопа. Всегда смотрите на конечный хоп и повторяйте тесты с разными протоколами/портами.

### Практические рекомендации

* Для отчёта провайдеру: запускать в `-r -c N -n` и приложить вывод.
* Сначала запуск без DNS (`-n`) ускорит и упростит чтение.
* Если ICMP блокированы, пробуйте `--tcp -P 80/443`.
* Сравнивайте результаты с разных точек (клиент и сервер).

### Windows-alternative

* `WinMTR` — GUI-альтернатива для Windows. Поведение аналогично.

### Вопросы для самопроверки

1. Почему `Loss%` на хопе 3 не обязательно означает проблему?
2. Когда стоит использовать `--tcp` вместо ICMP?
3. Как собрать автоматизированный отчёт `mtr` для техподдержки?
